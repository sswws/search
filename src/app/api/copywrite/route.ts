import { NextResponse } from 'next/server';

export async function GET(request: Request) {
  const { searchParams } = new URL(request.url);
  const title = searchParams.get('title') || 'çˆ†æ¬¾å†…å®¹';
  const platform = searchParams.get('platform') || 'çŸ­è§†é¢‘';

  try {
    // ğŸŒŸ æ ¸å¿ƒä¼˜åŒ–ï¼šæ™ºèƒ½åˆ†è¯å¼•æ“ï¼Œè‡ªåŠ¨æå–åŸè§†é¢‘æ ‡é¢˜é‡Œçš„æ ¸å¿ƒå–ç‚¹
    // å»é™¤ç‰¹æ®Šç¬¦å·ï¼Œå°†æ ‡é¢˜æ‹†åˆ†ä¸ºè¯ç»„
    const cleanTitle = title.replace(/[^\u4e00-\u9fa5a-zA-Z0-9]/g, ' ');
    const words = cleanTitle.split(/\s+/).filter(w => w.length > 1);
    
    // æå–æœ€é•¿çš„å‰ä¸‰ä¸ªè¯ä½œä¸ºæ ¸å¿ƒå…³é”®è¯ï¼Œå¦‚æœæå–ä¸åˆ°å°±ç”¨å¤‡ç”¨è¯
    const keyword1 = words[0] || title.substring(0, 6);
    const keyword2 = words[1] || 'åº•å±‚é€»è¾‘';
    const keyword3 = words[2] || 'æ ¸å¿ƒç»†èŠ‚';

    // ç»“æ„åº“ 1ï¼šé»„é‡‘ä¸‰ç§’é’©å­
    const hooks = [
      `åƒä¸‡åˆ«åˆ’èµ°ï¼å…³äºã€Œ${keyword1}ã€çš„ç§˜å¯†ï¼Œ99%çš„äººéƒ½ä¸çŸ¥é“ï¼`,
      `è¢«é—®çˆ†äº†ï¼åŸæ¥${platform}ä¸Šçˆ†ç«çš„ã€Œ${keyword1}ã€èƒŒåéšè—ç€è¿™æ ·çš„ç„æœº...`,
      `åŒè¡Œéƒ½ä¸æ„¿æ„è¯´çš„ç§˜å¯†ï¼Œä»Šå¤©æˆ‘æŠŠã€Œ${keyword1}ã€çš„${keyword2}è®²é€ï¼`,
      `å¦‚æœä½ ä¹Ÿå¯¹ã€Œ${keyword1}ã€æ„Ÿå…´è¶£ï¼Œè¿™æ¡è§†é¢‘ç»å¯¹èƒ½å¸®ä½ é¿å‘ï¼`,
      `åˆ«å†ä¹±èŠ±é’±äº†ï¼å†…è¡Œäººæ˜¯æ€ä¹ˆçœ‹ã€Œ${keyword1}ã€çš„ï¼Ÿ`,
      `ä»Šå¤©åˆ·åˆ°è¿™æ¡è§†é¢‘ç®—ä½ èµšåˆ°äº†ï¼å¸¦ä½ æ·±åº¦æ‹†è§£ã€Œ${title.substring(0, 15)}...ã€ã€‚`
    ];

    // ç»“æ„åº“ 2ï¼šå¹²è´§ä¸»ä½“ï¼ˆæ·±åº¦èåˆäº†åŸè§†é¢‘çš„å…³é”®è¯ï¼‰
    const bodies = [
      `å…¶å®å¾ˆå¤šäººåœ¨åšè¿™ä¸ªçš„æ—¶å€™éƒ½é™·å…¥äº†ä¸€ä¸ªè¯¯åŒºã€‚ç»è¿‡æˆ‘ä»¬å›¢é˜Ÿæ·±åº¦çš„æ‹†è§£å’Œæµ‹è¯•ï¼Œå‘ç°æƒ³è¦åšå¥½ï¼Œæ ¸å¿ƒåªçœ‹è¿™ä¸‰ç‚¹ï¼š\n\nç¬¬ä¸€ï¼Œå®šä½è¦ç²¾å‡†ã€‚å…³äº${keyword1}ï¼Œä¸è¦ç›²ç›®è·Ÿé£ï¼Œæ‰¾åˆ°å±äºä½ çš„æ ¸å¿ƒå·®å¼‚åŒ–ã€‚\nç¬¬äºŒï¼Œå°±æ˜¯${keyword2}ã€‚åœ¨è¿™ä¸ªçœ‹è„¸çš„æ—¶ä»£ï¼Œç¬¬ä¸€çœ¼çš„è´¨æ„Ÿå†³å®šäº†åœç•™ç‡ã€‚\nç¬¬ä¸‰ï¼Œæƒ…ç»ªä»·å€¼ã€‚ä½ çš„äº§å“åˆ°åº•è§£å†³äº†ç”¨æˆ·ä»€ä¹ˆç—›ç‚¹ï¼Ÿ\n\nä½ çœ‹é‚£äº›å¤§å‡ åä¸‡èµçš„åŒè¡Œï¼Œæ— ä¸€ä¾‹å¤–éƒ½æ˜¯æŠŠè¿™ä¸‰ç‚¹åšåˆ°äº†æè‡´ã€‚`,

      `è¿™ç»å¯¹æ˜¯ä»Šå¹´æœ€å¤§çš„çº¢åˆ©ï¼ä½ çŸ¥é“ä¸ºä»€ä¹ˆå¤§å®¶éƒ½åœ¨åšã€Œ${keyword1}ã€å—ï¼Ÿ\n\næœ¬è´¨ä¸Šï¼Œ${keyword2}æ‰æ˜¯å†³å®šæˆè´¥çš„å…³é”®ã€‚æˆ‘ä»¬å¤ç›˜äº†ä¸Šç™¾ä¸ªçˆ†æ¬¾æ¡ˆä¾‹ï¼Œå‘ç°ä»–ä»¬éƒ½æœ‰ä¸€ä¸ªå…±æ€§ï¼šå°±æ˜¯æŠŠç”¨æˆ·ä½“éªŒåšåˆ°äº†æè‡´ã€‚\n\næ™®é€šäººåªçœ‹è¡¨é¢ï¼Œè€ŒçœŸæ­£çš„é«˜æ‰‹éƒ½åœ¨ç ”ç©¶èƒŒåçš„${keyword3}ã€‚å¦‚æœä½ ç°åœ¨è¿˜æ²¡çœ‹æ‡‚è¿™ä¸ªé€»è¾‘ï¼ŒçœŸçš„ä¼šé”™è¿‡ä¸€æ³¢å¤§æœºä¼šï¼`,

      `ä»Šå¤©ç»™å¤§å®¶åˆ†äº«ä¸€ä¸ªéå¸¸è½åœ°çš„å®æ“æ–¹æ³•ã€‚å…³äºã€Œ${title}ã€ï¼Œå…¶å®æ ¸å¿ƒç§˜è¯€å°±è—åœ¨æ¯å¤©çš„æ—¥å¸¸é‡Œã€‚\n\næ­¥éª¤ä¸€ï¼šæ˜ç¡®ä½ çš„ç›®æ ‡ç¾¤ä½“ï¼Œç»“åˆ${keyword1}çš„ç‰¹æ€§ï¼Œä¸è¦è¯•å›¾è®¨å¥½æ‰€æœ‰äººã€‚\næ­¥éª¤äºŒï¼šæ‰“ç£¨ä½ çš„äº§å“ç»†èŠ‚ï¼Œç‰¹åˆ«æ˜¯å…³äº${keyword2}çš„éƒ¨åˆ†ï¼Œä¸€å®šè¦è¶…å‡ºé¢„æœŸã€‚\næ­¥éª¤ä¸‰ï¼šæŒç»­è¾“å‡ºé«˜ä»·å€¼å†…å®¹ï¼Œåˆ©ç”¨${keyword3}å»ºç«‹ä¿¡ä»»èƒŒä¹¦ã€‚\n\næŒ‰ç…§è¿™ä¸‰æ­¥èµ°ï¼Œæ–°æ‰‹ä¹Ÿèƒ½è½»æ¾æ‹¿åˆ°ç»“æœã€‚`,

      `æ‰“ç ´è®¤çŸ¥å±€é™ï¼å¾ˆå¤šæ–°æ‰‹åœ¨æ¥è§¦ã€Œ${keyword1}ã€æ—¶ï¼Œæœ€å®¹æ˜“çŠ¯çš„ä¸‰ä¸ªè‡´å‘½é”™è¯¯ï¼š\n\n1. ç›²ç›®æŠ•å…¥ï¼Œæ²¡æœ‰åšå¸‚åœºè°ƒç ”ã€‚\n2. å¿½è§†äº†${keyword2}çš„é‡è¦æ€§ï¼Œå¯¼è‡´è½¬åŒ–ç‡æä½ã€‚\n3. è¥é”€æ–¹å¼å¤ªå•ä¸€ï¼Œæ²¡æœ‰è·Ÿä¸Š${platform}çš„æœ€æ–°ç®—æ³•ï¼Œè¿${keyword3}éƒ½æ²¡ææ˜ç™½ã€‚\n\næƒ³è¦ç ´å±€ï¼Œå¿…é¡»ä»è¿™ä¸‰ä¸ªæ–¹é¢è¿›è¡Œå½»åº•çš„ä¼˜åŒ–ã€‚ä»Šå¤©è¿™æœŸå†…å®¹å¹²è´§æ»¡æ»¡ï¼Œå»ºè®®åå¤è§‚çœ‹ï¼`
    ];

    // ç»“æ„åº“ 3ï¼šå¼•å¯¼äº’åŠ¨
    const ctas = [
      `æ•´ç†ä¸æ˜“ï¼Œåˆ«å¿˜äº†ç‚¹èµæ”¶è—ï¼Œä¸‹æ¬¡æƒ³ç”¨çš„æ—¶å€™å°±æ‰¾ä¸åˆ°äº†ï¼å…³äº${keyword1}å¦‚æœæœ‰æ“ä½œä¸Šçš„é—®é¢˜ï¼Œè¯„è®ºåŒºç•™è¨€ï¼Œæˆ‘æ¥å¸®ä½ è§£ç­”ã€‚`,
      `è§‰å¾—æœ‰ç”¨çš„å®¶äººä»¬ï¼Œèµ¶ç´§@ä½ çš„æ€¨ç§é—ºèœœ/å…„å¼Ÿä¸€èµ·æ¥çœ‹ï¼å…³æ³¨æˆ‘ï¼Œå¸¦ä½ äº†è§£æ›´å¤šå…³äº${keyword2}çš„è¡Œä¸šå†…å¹•ã€‚`,
      `æƒ³è¦å®Œæ•´ç‰ˆæ“ä½œSOPçš„æœ‹å‹ï¼Œå¯ä»¥åœ¨è¯„è®ºåŒºç•™ä¸‹â€œæ±‚åˆ†äº«â€ï¼Œæˆ‘ä¼šç§å‘ç»™ä½ å“¦ï¼`,
      `ä½ åœ¨è¿™ä¸ªé—®é¢˜ä¸Šè¸©è¿‡å‘å—ï¼Ÿæ¬¢è¿åœ¨è¯„è®ºåŒºåˆ†äº«ä½ çš„ç»å†ã€‚å…³æ³¨æˆ‘ï¼Œæ¯å¤©å¸¦ä½ å­¦ç‚¹æ–°å¹²è´§ï¼`
    ];

    // ğŸŒŸ æ ¸å¿ƒé­”æ³•ï¼šä½¿ç”¨å“ˆå¸Œç®—æ³•è®¡ç®—æ ‡é¢˜çš„å”¯ä¸€å€¼
    // ç¡®ä¿åŒä¸€ä¸ªè§†é¢‘æ¯æ¬¡ç‚¹å¼€ç”Ÿæˆçš„æ–‡æ¡ˆæ˜¯ä¸€æ¨¡ä¸€æ ·çš„ï¼Œä½†ä¸åŒè§†é¢‘ç‚¹å¼€æ–‡æ¡ˆå®Œå…¨ä¸åŒï¼
    const hash = title.split('').reduce((a, b) => { a = ((a << 5) - a) + b.charCodeAt(0); return a & a }, 0);
    const absHash = Math.abs(hash);

    // æ ¹æ®å“ˆå¸Œå€¼éšæœºä½†ç¡®å®šåœ°æŠ½å–æ¨¡æ¿ç»„åˆ
    const hook = hooks[absHash % hooks.length];
    const body = bodies[(absHash >> 1) % bodies.length];
    const cta = ctas[(absHash >> 2) % ctas.length];
    
    // ç”ŸæˆåŸè§†é¢‘çš„ç²¾å‡†çƒ­é—¨æ ‡ç­¾
    const tags = `#${keyword1} #${platform}è¿è¥ #${keyword2} #å•†ä¸šæ€ç»´ #${keyword3} #æµé‡å¯†ç `;

    // æ¨¡æ‹ŸçœŸå® AI ç”Ÿæˆçš„ç½‘ç»œå»¶è¿Ÿ
    await new Promise(resolve => setTimeout(resolve, 800));

    return NextResponse.json({ hook, body, cta, tags });

  } catch (error) {
    return NextResponse.json({ error: 'æ–‡æ¡ˆæå–å¤±è´¥' }, { status: 500 });
  }
}